<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanRes 2.0 Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ngl@2.0.0-dev.37/dist/ngl.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1b7f58',
                        'accent-1': '#e6aeb9',
                        'accent-2': '#f2b4c0',
                    }
                }
            }
        }
    </script>
    <style>
        .loading { display: none; }
        .loading.active { display: block; }
        .hidden { display: none; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Filter pill animations */
        .filter-pill {
            transition: all 0.2s ease;
        }
        .filter-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Table styling */
        .gene-table { border-collapse: collapse; }
        .gene-table thead { position: sticky; top: 0; background: white; z-index: 10; }
        .gene-table th { cursor: pointer; user-select: none; }
        .gene-table th:hover { background: #f9fafb; }
        .gene-table tbody tr:hover { background: #f9fafb; }

        /* Quirky Loading Animation */
        .dna-helix {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .dna-strand {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        .dna-ball {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1b7f58, #2ea574);
            box-shadow: 0 0 20px rgba(27, 127, 88, 0.5);
        }

        .dna-ball:nth-child(1) { left: 0; top: 10%; animation: pulse 1s ease-in-out infinite; }
        .dna-ball:nth-child(2) { right: 0; top: 30%; animation: pulse 1s ease-in-out 0.2s infinite; }
        .dna-ball:nth-child(3) { left: 0; top: 50%; animation: pulse 1s ease-in-out 0.4s infinite; }
        .dna-ball:nth-child(4) { right: 0; top: 70%; animation: pulse 1s ease-in-out 0.6s infinite; }
        .dna-ball:nth-child(5) { left: 0; top: 90%; animation: pulse 1s ease-in-out 0.8s infinite; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
        }

        .bacteria {
            font-size: 60px;
            display: inline-block;
            animation: wiggle 1.5s ease-in-out infinite;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .loading-text {
            font-size: 24px;
            font-weight: bold;
            color: #1b7f58;
            margin-top: 30px;
            animation: colorCycle 3s ease-in-out infinite;
        }

        @keyframes colorCycle {
            0%, 100% { color: #1b7f58; }
            33% { color: #e6aeb9; }
            66% { color: #f2b4c0; }
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots span {
            animation: blink 1.4s infinite;
            opacity: 0;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .petri-dish {
            width: 300px;
            height: 300px;
            border: 4px solid #1b7f58;
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent);
            box-shadow: inset 0 0 50px rgba(27, 127, 88, 0.1), 0 0 20px rgba(27, 127, 88, 0.2);
        }

        .microbe {
            position: absolute;
            border-radius: 50%;
            opacity: 0.7;
        }

        .microbe1 {
            width: 30px;
            height: 30px;
            background: #e6aeb9;
            top: 20%;
            left: 30%;
            animation: float1 4s ease-in-out infinite;
        }

        .microbe2 {
            width: 25px;
            height: 25px;
            background: #f2b4c0;
            top: 60%;
            right: 25%;
            animation: float2 5s ease-in-out infinite;
        }

        .microbe3 {
            width: 35px;
            height: 35px;
            background: #9ed4c5;
            bottom: 30%;
            left: 20%;
            animation: float3 3.5s ease-in-out infinite;
        }

        @keyframes float1 {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(20px, -10px) rotate(90deg); }
            50% { transform: translate(10px, 20px) rotate(180deg); }
            75% { transform: translate(-10px, 10px) rotate(270deg); }
        }

        @keyframes float2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-30px, 20px) scale(1.2); }
        }

        @keyframes float3 {
            0%, 100% { transform: translate(0, 0) rotate(0deg) scale(1); }
            33% { transform: translate(15px, -15px) rotate(120deg) scale(1.1); }
            66% { transform: translate(-15px, 15px) rotate(240deg) scale(0.9); }
        }

        .fun-message {
            font-size: 14px;
            color: #666;
            margin-top: 20px;
            font-style: italic;
            transition: opacity 0.3s ease-in-out;
        }

        /* Fix list item alignment for long names */
        ul.list-disc.list-inside li {
            padding-left: 0;
        }

        ul.list-disc.list-inside li a {
            display: inline;
            word-break: break-word;
            vertical-align: top;
        }

        /* Sequence viewer styles */
        .sequence-container {
            background: #fafafa;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            word-break: break-all;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 8px;
            border-left: 3px solid #1b7f58;
        }

        .sequence-stats {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
        }

        #sequence-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #sequence-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .sequence-btn {
            padding: 4px 10px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s;
        }

        .sequence-btn:hover {
            background: #f9fafb;
            border-color: #1b7f58;
            color: #1b7f58;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #1f2937;
        }

        /* PDB Viewer Expandable Section */
        .pdb-viewer-container {
            display: none;
            margin-top: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            overflow: hidden;
        }

        .pdb-viewer-container.active {
            display: block;
        }

        /* Loading spinner for PDB viewer */
        .pdb-loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }

        .pdb-spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #9333ea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #viewport {
            width: 100%;
            height: 500px;
            background: #000;
        }

        .cluster-info {
            background: #f9fafb;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .cluster-members {
            max-height: 200px;
            overflow-y: auto;
            padding: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .viz-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 12px 16px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .viz-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s;
        }

        .viz-btn:hover {
            background: #f9fafb;
            border-color: #1b7f58;
            color: #1b7f58;
        }

        .viz-btn.active {
            background: #1b7f58;
            border-color: #1b7f58;
            color: white;
        }

        .cluster-toggle-btn {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .cluster-toggle-btn:hover {
            color: #1b7f58;
        }

        .rotate-icon {
            display: inline-block;
            transition: transform 0.3s;
        }

        .rotate-icon.open {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Indicator -->
    <div id="loading" class="loading active container mx-auto px-6 py-12 text-center">
        <div class="bacteria">ü¶†</div>

        <div class="petri-dish">
            <div class="microbe microbe1"></div>
            <div class="microbe microbe2"></div>
            <div class="microbe microbe3"></div>

            <div class="dna-helix">
                <div class="dna-strand">
                    <div class="dna-ball"></div>
                    <div class="dna-ball"></div>
                    <div class="dna-ball"></div>
                    <div class="dna-ball"></div>
                    <div class="dna-ball"></div>
                </div>
            </div>
        </div>

        <div class="loading-text">
            Loading the database<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
    </div>

    <!-- Sequence Modal -->
    <div id="sequence-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="text-lg font-semibold"></h3>
                <button class="close-modal" onclick="closeSequenceModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>


    <!-- Main Content -->
    <main id="mainContent" class="hidden container mx-auto px-6 py-8">
        <!-- Home View -->
        <div id="homeView">
            <section class="mb-8 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-3xl font-semibold text-gray-800 mb-3">PanRes 2.0</h2>
                <p class="text-gray-600 text-sm mb-4">
                    PanRes (Pan Resistance) is a curated collection of genes conferring resistance to antibiotics,
                    heavy metals, and biocides from multiple databases.
                </p>

                <!-- Statistics Charts -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                        <canvas id="mechanismsChart" width="200" height="200"></canvas>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                        <canvas id="databasesChart" width="200" height="200"></canvas>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                        <canvas id="phenotypesChart" width="200" height="200"></canvas>
                    </div>
                </div>

                <!-- Search -->
                <div class="mb-6">
                    <input type="search" id="searchInput"
                           placeholder="Search genes, classes, phenotypes..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                    <div id="searchResults" class="mt-2 max-h-60 overflow-y-auto"></div>
                </div>

                <!-- Category Buttons -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="showCategory('PanGene')"
                            class="bg-primary hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium">
                        PanRes Genes (<span id="countPanGene">0</span>)
                    </button>
                    <button onclick="showCategory('AntibioticClass')"
                            class="bg-primary hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium">
                        Antibiotic Classes (<span id="countClass">0</span>)
                    </button>
                    <button onclick="showCategory('Phenotype')"
                            class="bg-primary hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium">
                        Predicted Phenotypes (<span id="countPhenotype">0</span>)
                    </button>
                    <button onclick="showCategory('Mechanism')"
                            class="bg-primary hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium">
                        Resistance Mechanisms (<span id="countMechanism">0</span>)
                    </button>
                    <button onclick="showCategory('Database')"
                            class="bg-primary hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium">
                        Source Databases (<span id="countDatabase">0</span>)
                    </button>
                </div>
            </section>
        </div>

        <!-- List View -->
        <div id="listView" class="hidden">
            <div class="mb-4 flex items-center justify-between flex-wrap gap-4">
                <button onclick="showHome()"
                        class="bg-primary hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium">
                    ‚Üê Back to Home
                </button>
                <div class="flex gap-2">
                    <button onclick="toggleViewMode('table')" id="btnTableView"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded text-sm font-medium">
                        Table View
                    </button>
                    <button onclick="toggleViewMode('list')" id="btnListView"
                            class="bg-primary text-white px-4 py-2 rounded text-sm font-medium">
                        List View
                    </button>
                </div>
            </div>

            <h2 id="listTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>

            <!-- Advanced Filters (for PanGene view) -->
            <div id="advancedFilters" class="hidden mb-6 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç Filter & Group Genes</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <!-- Database Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Source Database</label>
                        <select id="filterDatabase" onchange="applyFilters()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary text-sm">
                            <option value="">All Databases</option>
                        </select>
                    </div>

                    <!-- Phenotype Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phenotype</label>
                        <select id="filterPhenotype" onchange="applyFilters()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary text-sm">
                            <option value="">All Phenotypes</option>
                        </select>
                    </div>

                    <!-- Resistance Class Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Resistance Class</label>
                        <select id="filterClass" onchange="applyFilters()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary text-sm">
                            <option value="">All Classes</option>
                        </select>
                    </div>

                    <!-- Mechanism Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mechanism</label>
                        <select id="filterMechanism" onchange="applyFilters()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary text-sm">
                            <option value="">All Mechanisms</option>
                        </select>
                    </div>
                </div>

                <!-- Search within results -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search in Results</label>
                    <input type="text" id="filterSearch" onkeyup="applyFilters()"
                           placeholder="Search gene names..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary text-sm">
                </div>

                <!-- Active Filters Display -->
                <div id="activeFilters" class="mb-4 flex flex-wrap gap-2 hidden"></div>

                <!-- Group By -->
                <div class="flex items-center gap-4">
                    <label class="text-sm font-medium text-gray-700">Group By:</label>
                    <select id="groupBy" onchange="applyGrouping()"
                            class="px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary text-sm">
                        <option value="">No Grouping</option>
                        <option value="database">Database</option>
                        <option value="phenotype">Phenotype</option>
                        <option value="class">Resistance Class</option>
                        <option value="mechanism">Mechanism</option>
                    </select>

                    <button onclick="clearFilters()"
                            class="ml-auto bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded text-sm font-medium">
                        Clear All Filters
                    </button>
                </div>

                <!-- Results Count -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="text-sm text-gray-600">
                        Showing <span id="filteredCount" class="font-bold text-primary">0</span> of
                        <span id="totalCount" class="font-bold">0</span> genes
                    </div>
                </div>
            </div>

            <div id="listContent" class="bg-white p-6 rounded-lg shadow-md border border-gray-200"></div>

            <!-- Pagination -->
            <div id="pagination" class="hidden mt-6 flex items-center justify-center gap-2"></div>
        </div>

        <!-- Details View -->
        <div id="detailsView" class="hidden">
            <div class="mb-4">
                <button onclick="showHome()"
                        class="bg-primary hover:bg-opacity-80 text-white px-4 py-2 rounded text-sm font-medium mr-2">
                    ‚Üê Back to Home
                </button>
                <button onclick="goBackToPreviousView()"
                        class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded text-sm font-medium">
                    ‚Üê Back
                </button>
            </div>
            <div id="detailsContent"></div>
        </div>
    </main>

    <script>
        // Global data store
        let panresData = null;
        let currentCategory = null;
        let currentItems = [];
        let filteredItems = [];
        let currentPage = 1;
        let itemsPerPage = 100;
        let currentViewMode = 'list';
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let activeFilters = {
            database: '',
            phenotype: '',
            class: '',
            mechanism: '',
            search: ''
        };

        // Navigation history stack
        let navigationHistory = [];

        // Predicate display names
        const PREDICATE_NAMES = {
            'rdf:type': 'Type',
            'rdfs:label': 'Label',
            'rdfs:comment': 'Comment',
            'has_length': 'Length',
            'same_as': 'Same As',
            'card_link': 'CARD Link',
            'accession': 'Accession',
            'is_from_database': 'Source Database',
            'has_resistance_class': 'Resistance Class',
            'has_predicted_phenotype': 'Predicted Phenotype',
            'has_mechanism_of_resistance': 'Resistance Mechanism',
            'translates_to': 'Translates To',
            'member_of': 'Member Of'
        };

        // Quirky loading messages
        const loadingMessages = [
            "Waking up the bacteria...",
            "Teaching genes to resist...",
            "Consulting with the microbes...",
            "Brewing antibiotic soup...",
            "Counting tiny rebellious genes...",
            "Asking bacteria nicely to cooperate...",
            "Sequencing DNA like a boss...",
            "Playing hide and seek with phenotypes...",
            "Herding antimicrobial cats...",
            "Convincing genes to share their secrets...",
            "Downloading genetic resistance from the cloud...",
            "Negotiating with stubborn plasmids..."
        ];

        let messageIndex = 0;
        let messageInterval;

        // Rotate funny messages
        function startLoadingMessages() {
            messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % loadingMessages.length;
                const msgElement = document.getElementById('funMessage');
                if (msgElement) {
                    msgElement.style.opacity = '0';
                    setTimeout(() => {
                        msgElement.textContent = loadingMessages[messageIndex];
                        msgElement.style.opacity = '1';
                    }, 200);
                }
            }, 2000);
        }

        // Load JSON data
        async function loadData() {
            startLoadingMessages();

            try {
                const response = await fetch('panres2.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                panresData = await response.json();

                initializeUI();

                clearInterval(messageInterval);
                document.getElementById('loading').classList.remove('active');
                document.getElementById('mainContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading data:', error);
                clearInterval(messageInterval);
                document.getElementById('loading').innerHTML =
                    '<div class="text-red-600 text-xl">‚ö†Ô∏è Error loading database</div><div class="mt-4 text-gray-600">Please ensure panres2.json is in the same directory.</div>';
            }
        }

        function initializeUI() {
            // Update counts
            document.getElementById('countPanGene').textContent = panresData.categories.PanGene.length;
            document.getElementById('countClass').textContent = panresData.categories.AntibioticClass.length;
            document.getElementById('countPhenotype').textContent = panresData.categories.Phenotype.length;
            document.getElementById('countMechanism').textContent = panresData.categories.Mechanism.length;
            document.getElementById('countDatabase').textContent = panresData.categories.Database.length;

            // Create charts
            createCharts();
        }

        function createCharts() {
            // Chart colors
            const primaryColor = '#1b7f58';
            const accentColors = ['#e6aeb9', '#f2b4c0', '#9ed4c5', '#f0c987', '#b8a9d4', '#f7a8a4', '#a8d8ea', '#ffd79d'];

            // Mechanisms Chart - count genes per resistance mechanism
            const mechanismCounts = {};
            panresData.categories.Mechanism.forEach(mechId => {
                const relatedGenes = findRelatedGenes(mechId);
                const mechSubject = getSubject(mechId);
                mechanismCounts[mechSubject ? mechSubject.label : mechId] = relatedGenes.length;
            });

            new Chart(document.getElementById('mechanismsChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(mechanismCounts),
                    datasets: [{
                        data: Object.values(mechanismCounts),
                        backgroundColor: accentColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: 'Genes by Resistance Mechanism',
                            font: { size: 14, weight: 'bold' },
                            color: '#1f2937'
                        }
                    }
                }
            });

            // Databases Chart - count genes per database
            const databaseCounts = {};
            panresData.categories.Database.forEach(dbId => {
                const relatedGenes = findRelatedGenes(dbId);
                const dbSubject = getSubject(dbId);
                databaseCounts[dbSubject ? dbSubject.label : dbId] = relatedGenes.length;
            });

            new Chart(document.getElementById('databasesChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(databaseCounts),
                    datasets: [{
                        data: Object.values(databaseCounts),
                        backgroundColor: accentColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: 'Genes by Database',
                            font: { size: 14, weight: 'bold' },
                            color: '#1f2937'
                        }
                    }
                }
            });

            // Phenotypes Chart - show top resistance classes
            const classCounts = {};
            panresData.categories.AntibioticClass.forEach(classId => {
                const relatedGenes = findRelatedGenes(classId);
                const classSubject = getSubject(classId);
                classCounts[classSubject ? classSubject.label : classId] = relatedGenes.length;
            });

            // Sort and get top 8
            const sortedClasses = Object.entries(classCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            new Chart(document.getElementById('phenotypesChart'), {
                type: 'doughnut',
                data: {
                    labels: sortedClasses.map(c => c[0]),
                    datasets: [{
                        data: sortedClasses.map(c => c[1]),
                        backgroundColor: accentColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, font: { size: 10 } }
                        },
                        title: {
                            display: true,
                            text: 'Top Resistance Classes',
                            font: { size: 14, weight: 'bold' },
                            color: '#1f2937'
                        }
                    }
                }
            });
        }

        function getSubject(id) {
            return panresData.subjects[id];
        }

        function getPredicate(pred) {
            return PREDICATE_NAMES[pred] || pred;
        }

        // View functions
        function showHome() {
            navigationHistory = []; // Clear history when going home
            document.getElementById('homeView').classList.remove('hidden');
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('detailsView').classList.add('hidden');
        }

        function goBackToPreviousView() {
            // Pop the current view from history
            if (navigationHistory.length > 0) {
                navigationHistory.pop(); // Remove current view
            }

            // If there's a previous view in history, restore it
            if (navigationHistory.length > 0) {
                const previousView = navigationHistory[navigationHistory.length - 1];

                if (previousView.view === 'list') {
                    // Restore the list view with all its state
                    currentCategory = previousView.category;
                    currentPage = previousView.page || 1;
                    currentViewMode = previousView.viewMode || 'list';
                    activeFilters = previousView.filters || {
                        database: '',
                        phenotype: '',
                        class: '',
                        mechanism: '',
                        search: ''
                    };

                    // Restore filter UI
                    if (document.getElementById('filterDatabase')) {
                        document.getElementById('filterDatabase').value = activeFilters.database;
                    }
                    if (document.getElementById('filterPhenotype')) {
                        document.getElementById('filterPhenotype').value = activeFilters.phenotype;
                    }
                    if (document.getElementById('filterClass')) {
                        document.getElementById('filterClass').value = activeFilters.class;
                    }
                    if (document.getElementById('filterMechanism')) {
                        document.getElementById('filterMechanism').value = activeFilters.mechanism;
                    }
                    if (document.getElementById('filterSearch')) {
                        document.getElementById('filterSearch').value = activeFilters.search;
                    }
                    if (document.getElementById('groupBy')) {
                        document.getElementById('groupBy').value = previousView.groupBy || '';
                    }

                    // Re-render the list
                    const titles = {
                        PanGene: 'PanRes Genes',
                        AntibioticClass: 'Antibiotic Classes',
                        Phenotype: 'Predicted Phenotypes',
                        Mechanism: 'Resistance Mechanisms',
                        Database: 'Source Databases'
                    };

                    const itemIds = panresData.categories[currentCategory];
                    document.getElementById('listTitle').textContent =
                        `${titles[currentCategory]} (${itemIds.length} items)`;

                    currentItems = itemIds
                        .map(id => getSubject(id))
                        .filter(item => item && item.label !== '+')
                        .sort((a, b) => a.label.localeCompare(b.label));

                    if (currentCategory === 'PanGene') {
                        document.getElementById('advancedFilters').classList.remove('hidden');
                        applyFilters();
                    } else {
                        document.getElementById('advancedFilters').classList.add('hidden');
                        filteredItems = currentItems;
                        renderList();
                    }

                    document.getElementById('homeView').classList.add('hidden');
                    document.getElementById('listView').classList.remove('hidden');
                    document.getElementById('detailsView').classList.add('hidden');
                } else if (previousView.view === 'relatedGenes') {
                    // Restore the related genes view
                    showRelatedGenes(previousView.entityId);
                    // Remove the duplicate entry that showRelatedGenes adds
                    navigationHistory.pop();
                } else if (previousView.view === 'details') {
                    // Restore the details view
                    showDetails(previousView.itemId);
                    // Remove the duplicate entry that showDetails adds
                    navigationHistory.pop();
                } else if (previousView.view === 'home') {
                    showHome();
                }
            } else {
                // No history, go back to home
                showHome();
            }
        }

        function showCategory(category) {
            currentCategory = category;
            currentPage = 1;
            currentViewMode = 'list';

            const titles = {
                PanGene: 'PanRes Genes',
                AntibioticClass: 'Antibiotic Classes',
                Phenotype: 'Predicted Phenotypes',
                Mechanism: 'Resistance Mechanisms',
                Database: 'Source Databases'
            };

            const itemIds = panresData.categories[category];

            document.getElementById('listTitle').textContent =
                `${titles[category]} (${itemIds.length} items)`;

            currentItems = itemIds
                .map(id => getSubject(id))
                .filter(item => item && item.label !== '+')  // Filter out the "+" phenotype marker
                .sort((a, b) => a.label.localeCompare(b.label));

            // Show advanced filters only for PanGene category
            if (category === 'PanGene') {
                document.getElementById('advancedFilters').classList.remove('hidden');
                populateFilterDropdowns();
                clearFilters();
            } else {
                document.getElementById('advancedFilters').classList.add('hidden');
                filteredItems = currentItems;
                renderList();
            }

            // Save current view to navigation history
            navigationHistory.push({
                view: 'list',
                category: category,
                page: currentPage,
                viewMode: currentViewMode,
                filters: {...activeFilters},
                groupBy: document.getElementById('groupBy')?.value || ''
            });

            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('detailsView').classList.add('hidden');
        }

        function populateFilterDropdowns() {
            // Populate database filter
            const databases = new Set();
            currentItems.forEach(gene => {
                if (gene.properties['same_as']) {
                    gene.properties['same_as'].forEach(val => {
                        if (!val.is_literal) {
                            const originalGene = getSubject(val.value);
                            if (originalGene && originalGene.properties['is_from_database']) {
                                originalGene.properties['is_from_database'].forEach(db => {
                                    const dbSubject = getSubject(db.value);
                                    if (dbSubject) databases.add(JSON.stringify({id: db.value, label: dbSubject.label}));
                                });
                            }
                        }
                    });
                }
            });

            const dbSelect = document.getElementById('filterDatabase');
            dbSelect.innerHTML = '<option value="">All Databases</option>';
            Array.from(databases).map(JSON.parse).sort((a, b) => a.label.localeCompare(b.label)).forEach(db => {
                dbSelect.innerHTML += `<option value="${db.id}">${db.label}</option>`;
            });

            // Populate phenotype filter
            const phenotypes = new Set();
            currentItems.forEach(gene => {
                if (gene.properties['has_predicted_phenotype']) {
                    gene.properties['has_predicted_phenotype'].forEach(val => {
                        if (!val.is_literal) {
                            const phenotype = getSubject(val.value);
                            if (phenotype && phenotype.label !== '+') {
                                phenotypes.add(JSON.stringify({id: val.value, label: phenotype.label}));
                            }
                        }
                    });
                }
            });

            const phenoSelect = document.getElementById('filterPhenotype');
            phenoSelect.innerHTML = '<option value="">All Phenotypes</option>';
            Array.from(phenotypes).map(JSON.parse).sort((a, b) => a.label.localeCompare(b.label)).forEach(p => {
                phenoSelect.innerHTML += `<option value="${p.id}">${p.label}</option>`;
            });

            // Populate resistance class filter
            const classes = new Set();
            currentItems.forEach(gene => {
                if (gene.properties['has_resistance_class']) {
                    gene.properties['has_resistance_class'].forEach(val => {
                        if (!val.is_literal) {
                            const cls = getSubject(val.value);
                            if (cls) classes.add(JSON.stringify({id: val.value, label: cls.label}));
                        }
                    });
                }
            });

            const classSelect = document.getElementById('filterClass');
            classSelect.innerHTML = '<option value="">All Classes</option>';
            Array.from(classes).map(JSON.parse).sort((a, b) => a.label.localeCompare(b.label)).forEach(c => {
                classSelect.innerHTML += `<option value="${c.id}">${c.label}</option>`;
            });

            // Populate mechanism filter
            const mechanisms = new Set();
            currentItems.forEach(gene => {
                if (gene.properties['has_mechanism_of_resistance']) {
                    gene.properties['has_mechanism_of_resistance'].forEach(val => {
                        if (!val.is_literal) {
                            const mech = getSubject(val.value);
                            if (mech) mechanisms.add(JSON.stringify({id: val.value, label: mech.label}));
                        }
                    });
                }
            });

            const mechSelect = document.getElementById('filterMechanism');
            mechSelect.innerHTML = '<option value="">All Mechanisms</option>';
            Array.from(mechanisms).map(JSON.parse).sort((a, b) => a.label.localeCompare(b.label)).forEach(m => {
                mechSelect.innerHTML += `<option value="${m.id}">${m.label}</option>`;
            });
        }

        function applyFilters() {
            activeFilters.database = document.getElementById('filterDatabase')?.value || '';
            activeFilters.phenotype = document.getElementById('filterPhenotype')?.value || '';
            activeFilters.class = document.getElementById('filterClass')?.value || '';
            activeFilters.mechanism = document.getElementById('filterMechanism')?.value || '';
            activeFilters.search = document.getElementById('filterSearch')?.value.toLowerCase() || '';

            filteredItems = currentItems.filter(gene => {
                // Database filter
                if (activeFilters.database) {
                    let hasDatabase = false;
                    if (gene.properties['same_as']) {
                        gene.properties['same_as'].forEach(val => {
                            if (!val.is_literal) {
                                const originalGene = getSubject(val.value);
                                if (originalGene && originalGene.properties['is_from_database']) {
                                    originalGene.properties['is_from_database'].forEach(db => {
                                        if (db.value === activeFilters.database) hasDatabase = true;
                                    });
                                }
                            }
                        });
                    }
                    if (!hasDatabase) return false;
                }

                // Phenotype filter
                if (activeFilters.phenotype) {
                    if (!gene.properties['has_predicted_phenotype'] ||
                        !gene.properties['has_predicted_phenotype'].some(v => v.value === activeFilters.phenotype)) {
                        return false;
                    }
                }

                // Class filter
                if (activeFilters.class) {
                    if (!gene.properties['has_resistance_class'] ||
                        !gene.properties['has_resistance_class'].some(v => v.value === activeFilters.class)) {
                        return false;
                    }
                }

                // Mechanism filter
                if (activeFilters.mechanism) {
                    if (!gene.properties['has_mechanism_of_resistance'] ||
                        !gene.properties['has_mechanism_of_resistance'].some(v => v.value === activeFilters.mechanism)) {
                        return false;
                    }
                }

                // Search filter
                if (activeFilters.search) {
                    if (!gene.label.toLowerCase().includes(activeFilters.search)) {
                        return false;
                    }
                }

                return true;
            });

            updateActiveFiltersDisplay();
            currentPage = 1;
            applyGrouping();
        }

        function updateActiveFiltersDisplay() {
            const container = document.getElementById('activeFilters');
            const filterPills = [];

            if (activeFilters.database) {
                const db = getSubject(activeFilters.database);
                filterPills.push({type: 'database', label: `Database: ${db?.label || activeFilters.database}`});
            }
            if (activeFilters.phenotype) {
                const ph = getSubject(activeFilters.phenotype);
                filterPills.push({type: 'phenotype', label: `Phenotype: ${ph?.label || activeFilters.phenotype}`});
            }
            if (activeFilters.class) {
                const cl = getSubject(activeFilters.class);
                filterPills.push({type: 'class', label: `Class: ${cl?.label || activeFilters.class}`});
            }
            if (activeFilters.mechanism) {
                const mech = getSubject(activeFilters.mechanism);
                filterPills.push({type: 'mechanism', label: `Mechanism: ${mech?.label || activeFilters.mechanism}`});
            }
            if (activeFilters.search) {
                filterPills.push({type: 'search', label: `Search: "${activeFilters.search}"`});
            }

            if (filterPills.length > 0) {
                container.classList.remove('hidden');
                container.innerHTML = filterPills.map(pill => `
                    <span class="filter-pill bg-primary text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                        ${pill.label}
                        <button onclick="removeFilter('${pill.type}')" class="hover:bg-white hover:bg-opacity-20 rounded-full px-1">‚úï</button>
                    </span>
                `).join('');
            } else {
                container.classList.add('hidden');
            }
        }

        function removeFilter(type) {
            if (type === 'database') document.getElementById('filterDatabase').value = '';
            if (type === 'phenotype') document.getElementById('filterPhenotype').value = '';
            if (type === 'class') document.getElementById('filterClass').value = '';
            if (type === 'mechanism') document.getElementById('filterMechanism').value = '';
            if (type === 'search') document.getElementById('filterSearch').value = '';
            applyFilters();
        }

        function clearFilters() {
            document.getElementById('filterDatabase').value = '';
            document.getElementById('filterPhenotype').value = '';
            document.getElementById('filterClass').value = '';
            document.getElementById('filterMechanism').value = '';
            document.getElementById('filterSearch').value = '';
            document.getElementById('groupBy').value = '';
            activeFilters = {database: '', phenotype: '', class: '', mechanism: '', search: ''};
            filteredItems = currentItems;
            updateActiveFiltersDisplay();
            currentPage = 1;
            renderList();
        }

        function applyGrouping() {
            const groupBy = document.getElementById('groupBy')?.value;

            if (!groupBy) {
                renderList();
                return;
            }

            const grouped = {};
            filteredItems.forEach(gene => {
                let groupKeys = [];

                if (groupBy === 'database') {
                    if (gene.properties['same_as']) {
                        gene.properties['same_as'].forEach(val => {
                            if (!val.is_literal) {
                                const originalGene = getSubject(val.value);
                                if (originalGene && originalGene.properties['is_from_database']) {
                                    originalGene.properties['is_from_database'].forEach(db => {
                                        const dbSubject = getSubject(db.value);
                                        if (dbSubject) groupKeys.push(dbSubject.label);
                                    });
                                }
                            }
                        });
                    }
                } else if (groupBy === 'phenotype') {
                    if (gene.properties['has_predicted_phenotype']) {
                        gene.properties['has_predicted_phenotype'].forEach(val => {
                            if (!val.is_literal) {
                                const phenotype = getSubject(val.value);
                                if (phenotype && phenotype.label !== '+') groupKeys.push(phenotype.label);
                            }
                        });
                    }
                } else if (groupBy === 'class') {
                    if (gene.properties['has_resistance_class']) {
                        gene.properties['has_resistance_class'].forEach(val => {
                            if (!val.is_literal) {
                                const cls = getSubject(val.value);
                                if (cls) groupKeys.push(cls.label);
                            }
                        });
                    }
                } else if (groupBy === 'mechanism') {
                    if (gene.properties['has_mechanism_of_resistance']) {
                        gene.properties['has_mechanism_of_resistance'].forEach(val => {
                            if (!val.is_literal) {
                                const mech = getSubject(val.value);
                                if (mech) groupKeys.push(mech.label);
                            }
                        });
                    }
                }

                if (groupKeys.length === 0) groupKeys = ['Uncategorized'];

                groupKeys.forEach(key => {
                    if (!grouped[key]) grouped[key] = [];
                    if (!grouped[key].find(g => g.id === gene.id)) {
                        grouped[key].push(gene);
                    }
                });
            });

            renderGroupedList(grouped);
        }

        function renderGroupedList(grouped) {
            const sortedGroups = Object.keys(grouped).sort((a, b) => a.localeCompare(b));

            let html = '';
            sortedGroups.forEach(groupName => {
                const items = grouped[groupName].sort((a, b) => a.label.localeCompare(b.label));
                html += `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 pb-2 border-b-2 border-primary">
                            ${groupName} <span class="text-sm text-gray-500">(${items.length})</span>
                        </h3>
                        <ul class="list-disc list-inside grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${items.map(item => `
                                <li class="py-1">
                                    <a href="#" onclick="showDetails('${item.id}'); return false;"
                                       class="text-primary hover:underline">
                                        ${item.label}
                                    </a>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });

            document.getElementById('listContent').innerHTML = html;
            document.getElementById('pagination').classList.add('hidden');
            updateCounts();
        }

        function toggleViewMode(mode) {
            currentViewMode = mode;
            currentPage = 1;

            // Update button styles
            if (mode === 'table') {
                document.getElementById('btnTableView').className = 'bg-primary text-white px-4 py-2 rounded text-sm font-medium';
                document.getElementById('btnListView').className = 'bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded text-sm font-medium';
            } else {
                document.getElementById('btnListView').className = 'bg-primary text-white px-4 py-2 rounded text-sm font-medium';
                document.getElementById('btnTableView').className = 'bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded text-sm font-medium';
            }

            renderList();
        }

        function renderList() {
            const groupBy = document.getElementById('groupBy')?.value;
            if (groupBy && currentCategory === 'PanGene') {
                applyGrouping();
                return;
            }

            updateCounts();

            if (currentViewMode === 'table' && currentCategory === 'PanGene') {
                renderTableView();
            } else {
                renderSimpleList();
            }
        }

        function renderSimpleList() {
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = filteredItems.slice(startIdx, endIdx);

            const listHtml = pageItems
                .map(item => `
                    <li class="py-2">
                        <a href="#" onclick="showDetails('${item.id}'); return false;"
                           class="text-primary hover:underline">
                            ${item.label}
                        </a>
                    </li>
                `).join('');

            document.getElementById('listContent').innerHTML =
                `<ul class="list-disc list-inside grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">${listHtml}</ul>`;

            renderPagination();
        }

        function renderTableView() {
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = filteredItems.slice(startIdx, endIdx);

            let html = `
                <div class="overflow-x-auto">
                    <table class="gene-table w-full text-sm">
                        <thead class="bg-gray-100 border-b-2 border-gray-300">
                            <tr>
                                <th class="text-left p-3 font-semibold" onclick="sortTable('label')">
                                    Gene Name ${currentSortColumn === 'label' ? (currentSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </th>
                                <th class="text-left p-3 font-semibold" onclick="sortTable('database')">
                                    Database ${currentSortColumn === 'database' ? (currentSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </th>
                                <th class="text-left p-3 font-semibold" onclick="sortTable('class')">
                                    Resistance Class ${currentSortColumn === 'class' ? (currentSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </th>
                                <th class="text-left p-3 font-semibold" onclick="sortTable('phenotype')">
                                    Phenotype ${currentSortColumn === 'phenotype' ? (currentSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </th>
                                <th class="text-left p-3 font-semibold" onclick="sortTable('mechanism')">
                                    Mechanism ${currentSortColumn === 'mechanism' ? (currentSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            pageItems.forEach(gene => {
                // Extract data
                const databases = [];
                if (gene.properties['same_as']) {
                    gene.properties['same_as'].forEach(val => {
                        if (!val.is_literal) {
                            const originalGene = getSubject(val.value);
                            if (originalGene && originalGene.properties['is_from_database']) {
                                originalGene.properties['is_from_database'].forEach(db => {
                                    const dbSubject = getSubject(db.value);
                                    if (dbSubject && !databases.includes(dbSubject.label)) {
                                        databases.push(dbSubject.label);
                                    }
                                });
                            }
                        }
                    });
                }

                const classes = [];
                if (gene.properties['has_resistance_class']) {
                    gene.properties['has_resistance_class'].forEach(val => {
                        if (!val.is_literal) {
                            const cls = getSubject(val.value);
                            if (cls) classes.push(cls.label);
                        }
                    });
                }

                const phenotypes = [];
                if (gene.properties['has_predicted_phenotype']) {
                    gene.properties['has_predicted_phenotype'].forEach(val => {
                        if (!val.is_literal) {
                            const phenotype = getSubject(val.value);
                            if (phenotype && phenotype.label !== '+') phenotypes.push(phenotype.label);
                        }
                    });
                }

                const mechanisms = [];
                if (gene.properties['has_mechanism_of_resistance']) {
                    gene.properties['has_mechanism_of_resistance'].forEach(val => {
                        if (!val.is_literal) {
                            const mech = getSubject(val.value);
                            if (mech) mechanisms.push(mech.label);
                        }
                    });
                }

                html += `
                    <tr class="border-b border-gray-200">
                        <td class="p-3">
                            <a href="#" onclick="showDetails('${gene.id}'); return false;"
                               class="text-primary hover:underline font-medium">
                                ${gene.label}
                            </a>
                        </td>
                        <td class="p-3 text-gray-700">${databases.slice(0, 2).join(', ')}${databases.length > 2 ? ` +${databases.length - 2}` : ''}</td>
                        <td class="p-3 text-gray-700">${classes.slice(0, 2).join(', ')}${classes.length > 2 ? ` +${classes.length - 2}` : ''}</td>
                        <td class="p-3 text-gray-700">${phenotypes.slice(0, 2).join(', ')}${phenotypes.length > 2 ? ` +${phenotypes.length - 2}` : ''}</td>
                        <td class="p-3 text-gray-700">${mechanisms.slice(0, 2).join(', ')}${mechanisms.length > 2 ? ` +${mechanisms.length - 2}` : ''}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('listContent').innerHTML = html;
            renderPagination();
        }

        function sortTable(column) {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            filteredItems.sort((a, b) => {
                let aVal = '';
                let bVal = '';

                if (column === 'label') {
                    aVal = a.label;
                    bVal = b.label;
                } else if (column === 'database') {
                    // Get first database
                    if (a.properties['same_as']) {
                        a.properties['same_as'].forEach(val => {
                            if (!val.is_literal && !aVal) {
                                const originalGene = getSubject(val.value);
                                if (originalGene && originalGene.properties['is_from_database']) {
                                    const db = getSubject(originalGene.properties['is_from_database'][0].value);
                                    if (db) aVal = db.label;
                                }
                            }
                        });
                    }
                    if (b.properties['same_as']) {
                        b.properties['same_as'].forEach(val => {
                            if (!val.is_literal && !bVal) {
                                const originalGene = getSubject(val.value);
                                if (originalGene && originalGene.properties['is_from_database']) {
                                    const db = getSubject(originalGene.properties['is_from_database'][0].value);
                                    if (db) bVal = db.label;
                                }
                            }
                        });
                    }
                } else {
                    const propMap = {
                        'class': 'has_resistance_class',
                        'phenotype': 'has_predicted_phenotype',
                        'mechanism': 'has_mechanism_of_resistance'
                    };
                    const prop = propMap[column];
                    if (a.properties[prop] && a.properties[prop][0]) {
                        const subject = getSubject(a.properties[prop][0].value);
                        if (subject) aVal = subject.label;
                    }
                    if (b.properties[prop] && b.properties[prop][0]) {
                        const subject = getSubject(b.properties[prop][0].value);
                        if (subject) bVal = subject.label;
                    }
                }

                const result = aVal.localeCompare(bVal);
                return currentSortDirection === 'asc' ? result : -result;
            });

            currentPage = 1;
            renderList();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);

            if (totalPages <= 1) {
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            document.getElementById('pagination').classList.remove('hidden');

            let html = '';

            // Previous button
            html += `
                <button onclick="changePage(${currentPage - 1})"
                        ${currentPage === 1 ? 'disabled' : ''}
                        class="px-3 py-1 rounded ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-primary text-white hover:bg-opacity-80'}">
                    ‚Üê Prev
                </button>
            `;

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            if (startPage > 1) {
                html += `<button onclick="changePage(1)" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">1</button>`;
                if (startPage > 2) html += `<span class="px-2">...</span>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <button onclick="changePage(${i})"
                            class="px-3 py-1 rounded ${i === currentPage ? 'bg-primary text-white' : 'bg-gray-200 hover:bg-gray-300'}">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += `<span class="px-2">...</span>`;
                html += `<button onclick="changePage(${totalPages})" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">${totalPages}</button>`;
            }

            // Next button
            html += `
                <button onclick="changePage(${currentPage + 1})"
                        ${currentPage === totalPages ? 'disabled' : ''}
                        class="px-3 py-1 rounded ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-primary text-white hover:bg-opacity-80'}">
                    Next ‚Üí
                </button>
            `;

            // Items per page selector
            html += `
                <select onchange="changeItemsPerPage(this.value)"
                        class="ml-4 px-3 py-1 border border-gray-300 rounded">
                    <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50/page</option>
                    <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100/page</option>
                    <option value="200" ${itemsPerPage === 200 ? 'selected' : ''}>200/page</option>
                    <option value="500" ${itemsPerPage === 500 ? 'selected' : ''}>500/page</option>
                </select>
            `;

            document.getElementById('pagination').innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderList();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function changeItemsPerPage(value) {
            itemsPerPage = parseInt(value);
            currentPage = 1;
            renderList();
        }

        function updateCounts() {
            if (document.getElementById('filteredCount')) {
                document.getElementById('filteredCount').textContent = filteredItems.length;
            }
            if (document.getElementById('totalCount')) {
                document.getElementById('totalCount').textContent = currentItems.length;
            }
        }

        function showDetails(id) {
            const subject = getSubject(id);
            if (!subject) {
                alert('Item not found');
                return;
            }

            // Save current state to navigation history before showing details
            const currentView = document.getElementById('listView').classList.contains('hidden') ? 'home' : 'list';
            if (currentView === 'list') {
                // Update the last history entry with current state or add new one
                const lastHistory = navigationHistory[navigationHistory.length - 1];
                if (lastHistory && lastHistory.view === 'list' && lastHistory.category === currentCategory) {
                    // Update existing entry
                    lastHistory.page = currentPage;
                    lastHistory.viewMode = currentViewMode;
                    lastHistory.filters = {...activeFilters};
                    lastHistory.groupBy = document.getElementById('groupBy')?.value || '';
                } else {
                    // Add new entry
                    navigationHistory.push({
                        view: 'list',
                        category: currentCategory,
                        page: currentPage,
                        viewMode: currentViewMode,
                        filters: {...activeFilters},
                        groupBy: document.getElementById('groupBy')?.value || ''
                    });
                }
            }

            // Add the detail view to history
            navigationHistory.push({
                view: 'details',
                itemId: id
            });

            // Determine entity type for display
            let entityType = '';
            if (panresData.categories.PanGene.includes(id)) entityType = 'PanRes Gene';
            else if (panresData.categories.AntibioticClass.includes(id)) entityType = 'Antibiotic Class';
            else if (panresData.categories.Phenotype.includes(id)) entityType = 'Phenotype';
            else if (panresData.categories.Mechanism.includes(id)) entityType = 'Resistance Mechanism';
            else if (panresData.categories.Database.includes(id)) entityType = 'Database';

            // Check if this is a drug combination
            const isDrugCombination = subject.properties['is_drug_combination'] &&
                                     subject.properties['is_drug_combination'][0].value === 'true';

            // Check if sequences are available
            let hasSequences = false;
            if (subject.gene_sequence || subject.protein_sequence) {
                hasSequences = true;
            } else if (subject.id.startsWith('Pan_')) {
                const geneId = subject.id.replace('Pan_', 'pan_');
                const correspondingGene = getSubject(geneId);
                if (correspondingGene && (correspondingGene.gene_sequence || correspondingGene.protein_sequence)) {
                    hasSequences = true;
                }
            }

            let html = `
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="mb-6">
                        ${entityType ? `<div class="text-sm font-medium text-primary mb-2">${entityType}${isDrugCombination ? ' (Drug Combination)' : ''}</div>` : ''}
                        <div class="flex items-center gap-3 mb-2">
                            <h2 class="text-3xl font-semibold text-gray-800">${subject.label}</h2>
                            ${hasSequences ? `
                                <button onclick="viewSequence('${subject.id}')" class="sequence-btn">View Sequence</button>
                                <button onclick="downloadFasta('${subject.id}', 'gene')" class="sequence-btn">Download FASTA</button>
                            ` : ''}
                        </div>
                        <p class="text-xs text-gray-400"><code>${subject.id}</code></p>
                    </div>
            `;

            // For drug combinations, show component drugs
            if (isDrugCombination && subject.properties['rdfs:subClassOf']) {
                const components = subject.properties['rdfs:subClassOf']
                    .filter(val => !val.is_literal && val.value !== 'AntibioticResistancePhenotype')
                    .map(val => {
                        const comp = getSubject(val.value);
                        return comp ? comp.label : val.value;
                    });

                if (components.length > 0) {
                    html += `
                        <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="text-sm font-semibold text-gray-700 mb-2">Combination Components:</h3>
                            <div class="flex flex-wrap gap-2">
                                ${components.map(comp => `<span class="bg-white px-3 py-1 rounded-full text-sm font-medium text-gray-700 border border-blue-300">${comp}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }

            html += ``;

            // For genes, show key information first
            const isGene = panresData.categories.PanGene.includes(id);

            if (isGene) {
                html += '<div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">';

                // Key attributes in cards (excluding is_from_database for now)
                const keyProps = ['has_resistance_class', 'has_predicted_phenotype', 'has_mechanism_of_resistance'];
                for (const prop of keyProps) {
                    if (subject.properties[prop]) {
                        const predDisplay = getPredicate(prop);
                        html += `
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-xs font-semibold text-gray-500 uppercase mb-2">${predDisplay}</div>
                                <div class="space-y-1">
                        `;
                        for (const val of subject.properties[prop]) {
                            if (!val.is_literal) {
                                const linkedSubject = getSubject(val.value);
                                const displayName = linkedSubject ? linkedSubject.label : val.value;

                                // Skip the standalone "+" phenotype marker
                                if (displayName === '+') continue;

                                html += `
                                    <div>
                                        <a href="#" onclick="showDetails('${val.value}'); return false;"
                                           class="text-primary hover:underline font-medium">
                                            ${displayName}
                                        </a>
                                    </div>
                                `;
                            } else {
                                html += `<div class="font-medium">${val.value}</div>`;
                            }
                        }
                        html += `</div></div>`;
                    }
                }

                html += '</div>';

                // Show database names mapping
                if (subject.properties['same_as']) {
                    html += `
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-3">Names in Source Databases</h3>
                            <div class="space-y-2">
                    `;

                    for (const val of subject.properties['same_as']) {
                        if (!val.is_literal) {
                            const originalGene = getSubject(val.value);
                            if (originalGene && originalGene.properties['is_from_database']) {
                                const databases = originalGene.properties['is_from_database']
                                    .map(db => {
                                        const dbSubject = getSubject(db.value);
                                        return dbSubject ? dbSubject.label : db.value;
                                    })
                                    .join(', ');

                                html += `
                                    <div class="flex items-start gap-2 text-sm">
                                        <div class="font-medium text-gray-700 min-w-[150px]">${databases}:</div>
                                        <div>
                                            <a href="#" onclick="showDetails('${val.value}'); return false;"
                                               class="text-primary hover:underline">
                                                ${originalGene.label}
                                            </a>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    }

                    html += `
                            </div>
                        </div>
                    `;
                }
            }

            // Show related genes if this is an antibiotic class, phenotype, mechanism, database, or cluster
            const relatedGenes = findRelatedGenes(id);
            if (relatedGenes.length > 0) {
                // Check if this is a cluster (panc_*)
                const isCluster = id.startsWith('panc_');

                html += `
                    <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">
                            ${isCluster ? 'Cluster Members' : 'Related Genes'} (${relatedGenes.length})
                            <button onclick="showRelatedGenes('${id}')"
                                    class="ml-2 text-sm bg-primary hover:bg-opacity-80 text-white px-3 py-1 rounded">
                                Browse All ‚ñ∂
                            </button>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${relatedGenes.slice(0, 9).map(geneId => {
                                const gene = getSubject(geneId);
                                return `
                                    <a href="#" onclick="showDetails('${geneId}'); return false;"
                                       class="text-primary hover:underline text-sm">
                                        ${gene.label}
                                    </a>
                                `;
                            }).join('')}
                            ${relatedGenes.length > 9 ? `<div class="text-sm text-gray-500">...and ${relatedGenes.length - 9} more</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Show protein clusters for gene clusters (panc_*)
            if (id.startsWith('panc_')) {
                const proteinClusterIds = findProteinClustersForGeneCluster(id);
                if (proteinClusterIds.length > 0) {
                    html += `
                        <div class="mb-6 bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">
                                Associated Protein Clusters (${proteinClusterIds.length})
                            </h3>
                    `;

                    for (const proteinClusterId of proteinClusterIds) {
                        const proteinCluster = getSubject(proteinClusterId);
                        const proteinClusterName = proteinCluster ? proteinCluster.label : proteinClusterId;
                        const proteinViewerId = `pdb-viewer-protein-cluster-${proteinClusterId}`;
                        const proteinMembers = findProteinClusterMembers(proteinClusterId);

                        html += `
                            <div class="mb-4 pb-4 border-b border-purple-200 last:border-b-0 last:pb-0">
                                <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
                                    <div class="text-sm font-medium text-gray-700">
                                        <a href="#" onclick="showDetails('${proteinClusterId}'); return false;"
                                           class="text-primary hover:underline">
                                            ${proteinClusterName}
                                        </a>
                                    </div>
                                    <button class="text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded"
                                            onclick="togglePDBViewer('${proteinViewerId}', '${proteinClusterId}')">
                                        <span class="rotate-icon" id="icon-${proteinViewerId}">‚ñ∂</span> View Centroid 3D Structure & Cluster Members
                                    </button>
                                </div>
                                <div class="text-xs text-gray-600 mb-2">
                                    Protein Members: ${proteinMembers.length}
                                </div>
                                <div id="${proteinViewerId}" class="pdb-viewer-container"></div>
                            </div>
                        `;
                    }

                    html += `
                        </div>
                    `;
                }
            }

            // Other properties section
            html += '<h3 class="text-xl font-semibold text-gray-800 mb-3">Additional Information</h3>';
            html += '<dl class="divide-y divide-gray-200">';

            // Skip certain properties that we've already shown or don't want to display
            const skipProps = ['rdfs:label', 'rdf:type', 'rdfs:subClassOf', 'is_drug_combination'];
            const alreadyShown = isGene ? ['has_resistance_class', 'has_predicted_phenotype', 'has_mechanism_of_resistance', 'is_from_database', 'same_as'] : [];

            for (const [pred, values] of Object.entries(subject.properties)) {
                // Filter out owl: and rdfs: prefixed properties, and skip already shown
                if (skipProps.includes(pred) || alreadyShown.includes(pred)) continue;
                if (pred.startsWith('owl:') || pred.startsWith('rdfs:')) continue;

                const predDisplay = getPredicate(pred);

                // Special handling for member_of (cluster membership)
                if (pred === 'member_of') {
                    html += `
                        <div class="py-3">
                            <dt class="text-sm font-medium text-gray-600 mb-1">Gene Cluster</dt>
                            <dd class="text-sm text-gray-800">
                    `;

                    for (const val of values) {
                        if (!val.is_literal) {
                            const clusterSubject = getSubject(val.value);
                            const displayName = clusterSubject ? clusterSubject.label : val.value;
                            const viewerId = `pdb-viewer-gene-cluster-${val.value}`;

                            html += `
                                <div class="mb-2">
                                    <div class="flex items-center gap-2">
                                        <a href="#" onclick="showDetails('${val.value}'); return false;"
                                           class="text-primary hover:underline">
                                            ${displayName}
                                        </a>
                                    </div>
                                </div>
                            `;
                        }
                    }

                    html += `
                            </dd>
                        </div>
                    `;
                    continue;
                }

                // Special handling for translates_to to also show protein cluster
                if (pred === 'translates_to' && isGene) {
                    html += `
                        <div class="py-3">
                            <dt class="text-sm font-medium text-gray-600 mb-1">${predDisplay}</dt>
                            <dd class="text-sm text-gray-800">
                    `;

                    for (const val of values) {
                        if (!val.is_literal) {
                            const proteinSubject = getSubject(val.value);
                            const displayName = proteinSubject ? proteinSubject.label : val.value;

                            html += `
                                <div class="mb-2">
                                    <a href="#" onclick="showDetails('${val.value}'); return false;"
                                       class="text-primary hover:underline">
                                        ${displayName}
                                    </a>
                                </div>
                            `;

                            // Check if this protein has a protein cluster
                            if (proteinSubject && proteinSubject.properties['member_of']) {
                                for (const proteinClusterRef of proteinSubject.properties['member_of']) {
                                    if (!proteinClusterRef.is_literal) {
                                        const proteinClusterId = proteinClusterRef.value;
                                        const proteinCluster = getSubject(proteinClusterId);
                                        const proteinClusterName = proteinCluster ? proteinCluster.label : proteinClusterId;
                                        const proteinViewerId = `pdb-viewer-protein-cluster-${proteinClusterId}`;

                                        html += `
                                            <div class="mt-3 pt-3 border-t border-gray-200">
                                                <div class="text-sm font-medium text-gray-600 mb-2">Protein Cluster</div>
                                                <div class="flex items-center gap-2 mb-2">
                                                    <a href="#" onclick="showDetails('${proteinClusterId}'); return false;"
                                                       class="text-primary hover:underline">
                                                        ${proteinClusterName}
                                                    </a>
                                                    <button class="text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded"
                                                            onclick="togglePDBViewer('${proteinViewerId}', '${proteinClusterId}')">
                                                        <span class="rotate-icon" id="icon-${proteinViewerId}">‚ñ∂</span> View 3D Structure & Cluster Members
                                                    </button>
                                                </div>
                                                <div id="${proteinViewerId}" class="pdb-viewer-container"></div>
                                            </div>
                                        `;
                                    }
                                }
                            }
                        }
                    }

                    html += `
                            </dd>
                        </div>
                    `;
                    continue;
                }

                html += `
                    <div class="py-3">
                        <dt class="text-sm font-medium text-gray-600 mb-1">${predDisplay}</dt>
                        <dd class="text-sm text-gray-800">
                `;

                for (const val of values) {
                    if (val.is_literal) {
                        // Check if it's a URL
                        if (val.value.startsWith('http://') || val.value.startsWith('https://')) {
                            html += `<div><a href="${val.value}" target="_blank" class="text-primary hover:underline break-all">${val.value}</a></div>`;
                        } else {
                            html += `<div class="bg-gray-100 px-2 py-1 rounded text-sm inline-block mb-1">${val.value}</div>`;
                        }
                    } else {
                        const linkedSubject = getSubject(val.value);
                        const displayName = linkedSubject ? linkedSubject.label : val.value;
                        html += `
                            <div>
                                <a href="#" onclick="showDetails('${val.value}'); return false;"
                                   class="text-primary hover:underline">
                                    ${displayName}
                                </a>
                            </div>
                        `;
                    }
                }

                html += `
                        </dd>
                    </div>
                `;
            }

            html += `
                    </dl>
                </div>
            `;

            document.getElementById('detailsContent').innerHTML = html;
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('detailsView').classList.remove('hidden');
        }

        function findRelatedGenes(entityId) {
            const relatedGenes = [];

            // Check all genes to see if they reference this entity
            for (const geneId of panresData.categories.PanGene) {
                const gene = getSubject(geneId);
                if (!gene) continue;

                // Check if gene references this entity in any property
                for (const values of Object.values(gene.properties)) {
                    for (const val of values) {
                        if (!val.is_literal && val.value === entityId) {
                            relatedGenes.push(geneId);
                            break;
                        }
                    }
                    if (relatedGenes.includes(geneId)) break;
                }
            }

            return relatedGenes;
        }

        function showRelatedGenes(entityId) {
            const entity = getSubject(entityId);
            const relatedGenes = findRelatedGenes(entityId);

            document.getElementById('listTitle').textContent =
                `Genes related to "${entity.label}" (${relatedGenes.length} items)`;

            const items = relatedGenes
                .map(id => getSubject(id))
                .filter(item => item)
                .sort((a, b) => a.label.localeCompare(b.label));

            const listHtml = items
                .map(item => `
                    <li class="py-2">
                        <a href="#" onclick="showDetails('${item.id}'); return false;"
                           class="text-primary hover:underline">
                            ${item.label}
                        </a>
                    </li>
                `).join('');

            document.getElementById('listContent').innerHTML =
                `<ul class="list-disc list-inside">${listHtml}</ul>`;

            // Save to navigation history
            navigationHistory.push({
                view: 'relatedGenes',
                entityId: entityId,
                category: 'PanGene'
            });

            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('detailsView').classList.add('hidden');
        }

        // Sequence viewer functions
        function viewSequence(id) {
            const subject = getSubject(id);
            if (!subject) return;

            // Check if viewing a protein, get the gene
            let geneForSequence = subject;
            if (subject.id.startsWith('Pan_') && !subject.gene_sequence && !subject.protein_sequence) {
                const geneId = subject.id.replace('Pan_', 'pan_');
                const correspondingGene = getSubject(geneId);
                if (correspondingGene) {
                    geneForSequence = correspondingGene;
                }
            }

            if (!geneForSequence.gene_sequence && !geneForSequence.protein_sequence) {
                alert('No sequence available');
                return;
            }

            // Build modal content
            let html = '<div class="space-y-4">';

            if (geneForSequence.gene_sequence) {
                const geneSeq = geneForSequence.gene_sequence;
                const gcContent = ((geneSeq.match(/[GC]/gi) || []).length / geneSeq.length * 100).toFixed(1);
                const header = `>${geneForSequence.id}`;
                html += `
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-800">Gene Sequence (Nucleotide)</h4>
                            <div class="flex gap-2">
                                <button onclick="copySequence('${geneForSequence.id}', 'gene')"
                                        class="sequence-btn">Copy Sequence</button>
                                <button onclick="downloadFasta('${geneForSequence.id}', 'gene')"
                                        class="sequence-btn">Download FASTA</button>
                            </div>
                        </div>
                        <div class="sequence-container">${header}\n${formatSequenceWithLineNumbers(geneSeq)}</div>
                        <div class="sequence-stats">
                            Length: <strong>${geneSeq.length} bp</strong> |
                            GC Content: <strong>${gcContent}%</strong>
                        </div>
                    </div>
                `;
            }

            if (geneForSequence.protein_sequence) {
                const proteinSeq = geneForSequence.protein_sequence;
                // Use uppercase Pan_ for protein header
                const proteinId = geneForSequence.id.replace('pan_', 'Pan_');
                const header = `>${proteinId}`;
                html += `
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-800">Protein Sequence (Amino Acids)</h4>
                            <div class="flex gap-2">
                                <button onclick="copySequence('${geneForSequence.id}', 'protein')"
                                        class="sequence-btn">Copy Sequence</button>
                                <button onclick="downloadFasta('${geneForSequence.id}', 'protein')"
                                        class="sequence-btn">Download FASTA</button>
                            </div>
                        </div>
                        <div class="sequence-container">${header}\n${formatSequenceWithLineNumbers(proteinSeq)}</div>
                        <div class="sequence-stats">
                            Length: <strong>${proteinSeq.length} aa</strong>
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            document.getElementById('modal-title').textContent = `Sequences: ${subject.label}`;
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('sequence-modal').classList.add('active');
        }

        function closeSequenceModal() {
            document.getElementById('sequence-modal').classList.remove('active');
        }

        function copySequence(id, type) {
            let subject = getSubject(id);
            if (!subject) return;

            // If this is a protein, get the corresponding gene
            if (subject.id.startsWith('Pan_') && !subject.gene_sequence && !subject.protein_sequence) {
                const geneId = subject.id.replace('Pan_', 'pan_');
                const correspondingGene = getSubject(geneId);
                if (correspondingGene) {
                    subject = correspondingGene;
                }
            }

            const sequence = type === 'gene' ? subject.gene_sequence : subject.protein_sequence;
            if (!sequence) {
                alert('Sequence not available');
                return;
            }

            // Format header: gene = pan_1, protein = Pan_1
            const header = type === 'protein' ? `>${subject.id.replace('pan_', 'Pan_')}` : `>${subject.id}`;
            const fastaContent = `${header}\n${sequence}`;

            // Copy to clipboard
            navigator.clipboard.writeText(fastaContent).then(() => {
                // Visual feedback - change button text temporarily
                const buttons = document.querySelectorAll(`button[onclick*="copySequence('${id}', '${type}')"]`);
                buttons.forEach(btn => {
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.borderColor = '#1b7f58';
                    btn.style.color = '#1b7f58';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.borderColor = '';
                        btn.style.color = '';
                    }, 2000);
                });
            }).catch(err => {
                alert('Failed to copy sequence to clipboard');
                console.error('Copy failed:', err);
            });
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('sequence-modal').addEventListener('click', (e) => {
                if (e.target.id === 'sequence-modal') {
                    closeSequenceModal();
                }
            });
        });

        function downloadFasta(id, type) {
            let subject = getSubject(id);
            if (!subject) return;

            // If this is a protein, get the corresponding gene
            if (subject.id.startsWith('Pan_') && !subject.gene_sequence && !subject.protein_sequence) {
                const geneId = subject.id.replace('Pan_', 'pan_');
                const correspondingGene = getSubject(geneId);
                if (correspondingGene) {
                    subject = correspondingGene;
                }
            }

            // Create multi-FASTA with both sequences if available
            let fastaContent = '';

            if (subject.gene_sequence) {
                const formattedSeq = subject.gene_sequence.match(/.{1,60}/g).join('\n');
                fastaContent += `>${subject.id}\n${formattedSeq}\n\n`;
            }

            if (subject.protein_sequence) {
                const proteinId = subject.id.replace('pan_', 'Pan_');
                const formattedSeq = subject.protein_sequence.match(/.{1,60}/g).join('\n');
                fastaContent += `>${proteinId}\n${formattedSeq}\n`;
            }

            if (!fastaContent) {
                alert('Sequence not available');
                return;
            }

            // Create download
            const blob = new Blob([fastaContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${subject.id}.fasta`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatSequenceWithLineNumbers(sequence, charsPerLine = 60) {
            if (!sequence) return '';

            const lines = [];
            for (let i = 0; i < sequence.length; i += charsPerLine) {
                const lineNum = String(i + 1).padStart(6, ' ');
                const seqChunk = sequence.substr(i, charsPerLine);
                lines.push(`${lineNum}  ${seqChunk}`);
            }
            return lines.join('\n');
        }

        // PDB Visualization Functions
        let nglStage = null;

        // Extract pan ID from filename (e.g., "pan_1_v1.0.1_..." -> "pan_1")
        function extractPanIdFromFilename(filename) {
            const match = filename.match(/^(pan_\d+)_/);
            return match ? match[1] : null;
        }

        // Get cluster ID from gene ID (e.g., "pan_53" -> "panc_53")
        function getClusterIdFromGene(geneId) {
            // Extract the numeric part from pan_X
            const match = geneId.match(/^pan_(\d+)$/);
            if (match) {
                return `panc_${match[1]}`;
            }
            return null;
        }

        // Check if PDB file exists for a gene
        async function checkPDBExists(geneId) {
            try {
                // Try to find a PDB file matching pan_X_v*.pdb pattern
                const response = await fetch(`pdb_files/${geneId}_v1.0.1_identical_unrelaxed_rank_001_alphafold2_ptm_model_1_seed_000.pdb`, {
                    method: 'HEAD'
                });
                if (response.ok) return true;

                // Try other model variants
                for (let model = 1; model <= 5; model++) {
                    const testResponse = await fetch(`pdb_files/${geneId}_v1.0.1_identical_unrelaxed_rank_001_alphafold2_ptm_model_${model}_seed_000.pdb`, {
                        method: 'HEAD'
                    });
                    if (testResponse.ok) return true;
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        // Get PDB file path for a gene
        async function getPDBPath(geneId) {
            // Try different model variants
            for (let model = 1; model <= 5; model++) {
                const path = `pdb_files/${geneId}_v1.0.1_identical_unrelaxed_rank_001_alphafold2_ptm_model_${model}_seed_000.pdb`;
                try {
                    const response = await fetch(path, { method: 'HEAD' });
                    if (response.ok) return path;
                } catch (error) {
                    continue;
                }
            }
            return null;
        }

        // Find cluster members
        function findClusterMembers(clusterId) {
            const members = [];
            for (const geneId of panresData.categories.PanGene) {
                const gene = getSubject(geneId);
                if (!gene || !gene.properties['member_of']) continue;

                // Check if this gene is a member of the cluster
                const isMember = gene.properties['member_of'].some(val =>
                    !val.is_literal && val.value === clusterId
                );

                if (isMember) {
                    members.push(geneId);
                }
            }
            return members;
        }

        // Find protein cluster members (all proteins that are member_of a protein cluster centroid)
        function findProteinClusterMembers(proteinClusterId) {
            const members = [];
            // Search through all subjects to find proteins
            for (const subjectId in panresData.subjects) {
                const subject = panresData.subjects[subjectId];

                // Check if this is a PanProtein type
                if (!subject.types || !subject.types.includes('PanProtein')) continue;
                if (!subject.properties['member_of']) continue;

                // Check if this protein is a member of the cluster
                const isMember = subject.properties['member_of'].some(val =>
                    !val.is_literal && val.value === proteinClusterId
                );

                if (isMember) {
                    members.push(subjectId);
                }
            }
            return members;
        }

        // Find all unique protein clusters associated with genes in a gene cluster
        function findProteinClustersForGeneCluster(geneClusterId) {
            const proteinClusters = new Set();

            // Get all genes in the gene cluster
            const genes = findClusterMembers(geneClusterId);

            // For each gene, find its proteins and their protein clusters
            for (const geneId of genes) {
                const gene = getSubject(geneId);
                if (!gene || !gene.properties['translates_to']) continue;

                // Get proteins this gene translates to
                for (const proteinRef of gene.properties['translates_to']) {
                    if (proteinRef.is_literal) continue;

                    const proteinId = proteinRef.value;
                    const protein = getSubject(proteinId);
                    if (!protein || !protein.properties['member_of']) continue;

                    // Get protein clusters this protein belongs to
                    for (const clusterRef of protein.properties['member_of']) {
                        if (!clusterRef.is_literal) {
                            proteinClusters.add(clusterRef.value);
                        }
                    }
                }
            }

            return Array.from(proteinClusters);
        }

        // Resolve protein cluster (Pan_XXXX) to gene with PDB structure
        async function resolveProteinToGene(proteinClusterId) {
            const proteinCluster = getSubject(proteinClusterId);
            if (!proteinCluster) return null;

            // Check if this protein cluster has a corresponding gene
            // Pattern: Pan_XXXX -> pan_XXXX
            const match = proteinClusterId.match(/^Pan_(\d+)$/);
            if (match) {
                const geneId = `pan_${match[1]}`;
                const gene = getSubject(geneId);

                // Check if this gene has a PDB
                if (gene) {
                    const hasPDB = await checkPDBExists(geneId);
                    if (hasPDB) return geneId;

                    // If this gene doesn't have PDB, check its cluster
                    if (gene.properties['member_of']) {
                        for (const clusterRef of gene.properties['member_of']) {
                            if (!clusterRef.is_literal) {
                                const repGene = await getClusterRepresentative(clusterRef.value);
                                if (repGene) return repGene;
                            }
                        }
                    }
                }
            }

            // If the protein cluster itself has member_of pointing to another protein cluster
            // Follow that chain (e.g., Pan_10044 -> member_of -> Pan_8331)
            if (proteinCluster.properties['member_of']) {
                for (const memberOf of proteinCluster.properties['member_of']) {
                    if (!memberOf.is_literal) {
                        const parentProteinId = memberOf.value;

                        // Check if parent is also a protein cluster (Pan_XXXX)
                        if (parentProteinId.match(/^Pan_\d+$/)) {
                            const result = await resolveProteinToGene(parentProteinId);
                            if (result) return result;
                        }
                        // Or if it's a gene cluster (panc_XXXX)
                        else if (parentProteinId.match(/^panc_\d+$/)) {
                            const result = await getClusterRepresentative(parentProteinId);
                            if (result) return result;
                        }
                    }
                }
            }

            return null;
        }

        // Get centroid gene for cluster (the one with PDB structure)
        async function getClusterRepresentative(clusterId) {
            // Handle protein clusters (Pan_XXXX)
            if (clusterId.match(/^Pan_\d+$/)) {
                return await resolveProteinToGene(clusterId);
            }

            // Handle gene clusters (panc_XXXX)
            // First, try the gene matching the cluster ID
            const match = clusterId.match(/^panc_(\d+)$/);
            if (match) {
                const geneId = `pan_${match[1]}`;
                const hasPDB = await checkPDBExists(geneId);
                if (hasPDB) return geneId;
            }

            // If not found, search through all cluster members
            const members = findClusterMembers(clusterId);
            for (const memberId of members) {
                const hasPDB = await checkPDBExists(memberId);
                if (hasPDB) {
                    return memberId;
                }
            }

            return null;
        }

        // Store NGL stages for multiple viewers
        const nglStages = {};
        const nglComponents = {};
        const currentRepresentation = {};
        const currentColorScheme = {};
        const isSpinning = {};

        // Toggle PDB viewer expansion
        async function togglePDBViewer(viewerId, clusterId) {
            const container = document.getElementById(viewerId);
            const icon = document.getElementById(`icon-${viewerId}`);

            if (!container) return;

            // If already open, close it
            if (container.classList.contains('active')) {
                container.classList.remove('active');
                icon.classList.remove('open');
                if (nglStages[viewerId]) {
                    nglStages[viewerId].dispose();
                    delete nglStages[viewerId];
                    delete nglComponents[viewerId];
                    delete currentRepresentation[viewerId];
                }
                return;
            }

            // Open and load content
            icon.classList.add('open');

            const clusterSubject = getSubject(clusterId);
            if (!clusterSubject) {
                alert('Cluster not found');
                return;
            }

            // Get representative gene
            const repGene = await getClusterRepresentative(clusterId);
            if (!repGene) {
                container.innerHTML = '<div class="p-4 text-sm text-gray-600">No PDB structure available for this cluster</div>';
                container.classList.add('active');
                return;
            }

            // Get PDB file path
            const pdbPath = await getPDBPath(repGene);
            if (!pdbPath) {
                container.innerHTML = '<div class="p-4 text-sm text-gray-600">PDB file not found</div>';
                container.classList.add('active');
                return;
            }

            // Determine if this is a protein cluster (Pan_XXXX) or gene cluster (panc_XXXX)
            const isProteinCluster = clusterId.match(/^Pan_\d+$/);
            const isGeneCluster = clusterId.match(/^panc_\d+$/);

            // Get cluster members
            let members = [];
            let clusterType = 'Cluster';
            let memberType = 'Members';

            if (isProteinCluster) {
                members = findProteinClusterMembers(clusterId);
                clusterType = 'Protein Cluster';
                memberType = 'Protein Members';
            } else if (isGeneCluster) {
                members = findClusterMembers(clusterId);
                clusterType = 'Gene Cluster';
                memberType = 'Gene Members';
            } else {
                members = findClusterMembers(clusterId);
            }

            // Build viewer HTML
            const viewportId = `viewport-${viewerId}`;
            const membersHtml = members
                .sort((a, b) => a.localeCompare(b))
                .map(memberId => {
                    const member = getSubject(memberId);
                    const isCentroid = memberId === clusterId || memberId === repGene;

                    // For protein clusters, show both the protein and its corresponding gene
                    let extraInfo = '';
                    if (isProteinCluster && member) {
                        // Try to find the corresponding gene
                        const geneMatch = memberId.match(/^Pan_(\d+)$/);
                        if (geneMatch) {
                            const correspondingGene = `pan_${geneMatch[1]}`;
                            const geneSubject = getSubject(correspondingGene);
                            if (geneSubject) {
                                extraInfo = ` <span class="text-xs text-gray-500">(gene: <a href="#" onclick="showDetails('${correspondingGene}'); return false;" class="text-primary hover:underline">${correspondingGene}</a>)</span>`;
                            }
                        }
                    }

                    return `
                        <div class="py-1 ${isCentroid ? 'font-semibold text-primary' : ''}">
                            <a href="#" onclick="showDetails('${memberId}'); return false;"
                               class="text-primary hover:underline">
                                ${member ? member.label : memberId}
                            </a>
                            ${isCentroid ? ' <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">Centroid - 3D structure</span>' : ''}
                            ${extraInfo}
                        </div>
                    `;
                }).join('');

            container.innerHTML = `
                <div class="viz-controls">
                    <div class="mb-2">
                        <span class="text-xs font-medium text-gray-600">Representation:</span>
                        <button class="viz-btn active" data-rep onclick="changeRepresentation('${viewerId}', 'cartoon')">Cartoon</button>
                        <button class="viz-btn" data-rep onclick="changeRepresentation('${viewerId}', 'backbone')">Backbone</button>
                        <button class="viz-btn" data-rep onclick="changeRepresentation('${viewerId}', 'ball+stick')">Ball+Stick</button>
                        <button class="viz-btn" data-rep onclick="changeRepresentation('${viewerId}', 'licorice')">Licorice</button>
                        <button class="viz-btn" data-rep onclick="changeRepresentation('${viewerId}', 'spacefill')">Spacefill</button>
                        <button class="viz-btn" data-rep onclick="changeRepresentation('${viewerId}', 'surface')">Surface</button>
                        <button class="viz-btn" data-rep onclick="changeRepresentation('${viewerId}', 'ribbon')">Ribbon</button>
                        <button class="viz-btn" data-rep onclick="changeRepresentation('${viewerId}', 'rope')">Rope</button>
                        <button class="viz-btn" data-rep onclick="changeRepresentation('${viewerId}', 'tube')">Tube</button>
                    </div>
                    <div class="mb-2">
                        <span class="text-xs font-medium text-gray-600">Color Scheme:</span>
                        <button class="viz-btn active" data-color onclick="changeColorScheme('${viewerId}', '')">Default</button>
                        <button class="viz-btn" data-color onclick="changeColorScheme('${viewerId}', 'chainname')">Chain</button>
                        <button class="viz-btn" data-color onclick="changeColorScheme('${viewerId}', 'element')">Element</button>
                        <button class="viz-btn" data-color onclick="changeColorScheme('${viewerId}', 'residueindex')">Residue</button>
                        <button class="viz-btn" data-color onclick="changeColorScheme('${viewerId}', 'sstruc')">Secondary Structure</button>
                        <button class="viz-btn" data-color onclick="changeColorScheme('${viewerId}', 'bfactor')">B-factor</button>
                        <button class="viz-btn" data-color onclick="changeColorScheme('${viewerId}', 'hydrophobicity')">Hydrophobicity</button>
                        <button class="viz-btn" data-color onclick="changeColorScheme('${viewerId}', 'atomindex')">Atom Index</button>
                        <button class="viz-btn" data-color onclick="changeColorScheme('${viewerId}', 'random')">Random</button>
                    </div>
                    <div class="mb-2">
                        <span class="text-xs font-medium text-gray-600">Background:</span>
                        <button class="viz-btn active" data-bg onclick="changeBackground('${viewerId}', 'black')">Black</button>
                        <button class="viz-btn" data-bg onclick="changeBackground('${viewerId}', 'white')">White</button>
                        <button class="viz-btn" data-bg onclick="changeBackground('${viewerId}', 'gray')">Gray</button>
                        <button class="viz-btn" data-bg onclick="changeBackground('${viewerId}', '#1a1a2e')">Dark Blue</button>
                        <button class="viz-btn" data-bg onclick="changeBackground('${viewerId}', '#0f0f23')">Navy</button>
                        <button class="viz-btn" data-bg onclick="changeBackground('${viewerId}', '#2d2d2d')">Charcoal</button>
                    </div>
                    <div>
                        <span class="text-xs font-medium text-gray-600">Actions:</span>
                        <button class="viz-btn" onclick="downloadPDB('${pdbPath}', '${repGene}')">Download PDB</button>
                        <button class="viz-btn" onclick="resetView('${viewerId}')">Reset View</button>
                        <button class="viz-btn" onclick="toggleSpin('${viewerId}')">Toggle Spin</button>
                    </div>
                </div>
                <div class="cluster-info">
                    <div class="text-sm">
                        <strong>${clusterType}:</strong> ${clusterId} |
                        <strong>Centroid Gene:</strong> ${repGene} (3D structure) |
                        <strong>${memberType}:</strong> ${members.length}
                    </div>
                </div>
                <div id="${viewportId}" style="width: 100%; height: 500px; background: #000000; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div class="pdb-loading-spinner">
                        <div class="pdb-spinner"></div>
                        <span>Loading 3D structure...</span>
                    </div>
                </div>
                <div class="cluster-members">
                    <h4 class="font-semibold text-gray-800 mb-2">${memberType} (${members.length}):</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">${membersHtml}</div>
                </div>
            `;

            container.classList.add('active');

            // Initialize representation and color tracking
            currentRepresentation[viewerId] = 'cartoon';
            currentColorScheme[viewerId] = '';
            isSpinning[viewerId] = false;

            // Load PDB structure
            setTimeout(() => loadPDBStructure(viewportId, viewerId, pdbPath), 100);
        }

        // Load PDB structure using NGL
        function loadPDBStructure(viewportId, viewerId, pdbPath) {
            const viewport = document.getElementById(viewportId);
            if (!viewport) return;

            // Clear previous structure for this viewer
            if (nglStages[viewerId]) {
                nglStages[viewerId].dispose();
            }

            // Create new NGL stage
            nglStages[viewerId] = new NGL.Stage(viewport, {
                backgroundColor: 'black'
            });

            // Load PDB file
            nglStages[viewerId].loadFile(pdbPath, { ext: 'pdb' }).then(function (component) {
                nglComponents[viewerId] = component;

                // Default representation: cartoon with package default colors
                component.addRepresentation('cartoon');

                // Auto-view
                component.autoView();

                // Handle window resize
                window.addEventListener('resize', function () {
                    if (nglStages[viewerId]) nglStages[viewerId].handleResize();
                });
            }).catch(function (error) {
                console.error('Error loading PDB:', error);
                viewport.innerHTML = '<div class="flex items-center justify-center h-full text-white">Failed to load PDB structure</div>';
            });
        }

        // Change visualization representation
        function changeRepresentation(viewerId, repType) {
            if (!nglComponents[viewerId]) return;

            // Update button states for representation buttons
            const container = document.getElementById(viewerId);
            container.querySelectorAll('.viz-btn[data-rep]').forEach(btn => {
                if (btn.textContent.toLowerCase().replace('+', '') === repType.replace('+', '')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Remove all representations
            nglComponents[viewerId].removeAllRepresentations();

            // Build representation config
            const repConfig = {};

            // Apply current color scheme if set
            if (currentColorScheme[viewerId]) {
                repConfig.colorScheme = currentColorScheme[viewerId];
            }

            // Add type-specific settings
            if (repType === 'surface') {
                repConfig.opacity = 0.8;
            }

            nglComponents[viewerId].addRepresentation(repType, repConfig);
            nglComponents[viewerId].autoView();

            currentRepresentation[viewerId] = repType;
        }

        // Download PDB file
        async function downloadPDB(pdbPath, geneName) {
            try {
                const response = await fetch(pdbPath);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${geneName}.pdb`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading PDB:', error);
                alert('Failed to download PDB file');
            }
        }

        // Change color scheme
        function changeColorScheme(viewerId, colorScheme) {
            if (!nglComponents[viewerId]) return;

            // Update button states for color buttons
            const container = document.getElementById(viewerId);
            container.querySelectorAll('.viz-btn[data-color]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Store the color scheme
            currentColorScheme[viewerId] = colorScheme;

            // Remove all representations
            nglComponents[viewerId].removeAllRepresentations();

            // Build representation config
            const repConfig = {};
            if (colorScheme) {
                repConfig.colorScheme = colorScheme;
            }

            // Add type-specific settings
            const repType = currentRepresentation[viewerId];
            if (repType === 'surface') {
                repConfig.opacity = 0.8;
            }

            nglComponents[viewerId].addRepresentation(repType, repConfig);
            nglComponents[viewerId].autoView();
        }

        // Reset view to default
        function resetView(viewerId) {
            if (!nglComponents[viewerId]) return;
            nglComponents[viewerId].autoView();
        }

        // Toggle spin animation
        function toggleSpin(viewerId) {
            if (!nglStages[viewerId]) return;

            isSpinning[viewerId] = !isSpinning[viewerId];

            if (isSpinning[viewerId]) {
                nglStages[viewerId].setSpin(true);
            } else {
                nglStages[viewerId].setSpin(false);
            }
        }

        // Change background color
        function changeBackground(viewerId, color) {
            if (!nglStages[viewerId]) return;

            // Update button states for background buttons
            const container = document.getElementById(viewerId);
            container.querySelectorAll('.viz-btn[data-bg]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Set the background color
            nglStages[viewerId].setParameters({ backgroundColor: color });
        }

        // Search functionality
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.toLowerCase().trim();

            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(() => {
                const results = [];

                for (const [id, subject] of Object.entries(panresData.subjects)) {
                    const labelLower = subject.label.toLowerCase();
                    const idLower = subject.id.toLowerCase();

                    if (labelLower.includes(query) || idLower.includes(query)) {
                        // Calculate match score for prioritization
                        let score = 0;

                        // Highest priority: exact match
                        if (labelLower === query || idLower === query) {
                            score = 1000;
                        }
                        // High priority: starts with query
                        else if (labelLower.startsWith(query) || idLower.startsWith(query)) {
                            score = 500;
                        }
                        // Medium priority: contains query with word boundary
                        else if (labelLower.match(new RegExp('\\b' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'))) ||
                                 idLower.match(new RegExp('\\b' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')))) {
                            score = 100;
                        }
                        // Lower priority: contains query anywhere
                        else {
                            score = 50;
                        }

                        // Bonus for shorter names (more specific matches)
                        score += Math.max(0, 50 - subject.label.length);

                        results.push({ subject, score });
                    }
                }

                // Sort by score (descending), then by label length (ascending), then alphabetically
                results.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    if (a.subject.label.length !== b.subject.label.length) {
                        return a.subject.label.length - b.subject.label.length;
                    }
                    return a.subject.label.localeCompare(b.subject.label);
                });

                // Take top 20 results
                const topResults = results.slice(0, 20);

                const resultsHtml = topResults
                    .map(({ subject: item }) => {
                        // Determine type
                        let typeLabel = 'Other';
                        if (panresData.categories.PanGene.includes(item.id)) typeLabel = 'PanGene';
                        else if (panresData.categories.AntibioticClass.includes(item.id)) typeLabel = 'Resistance Class';
                        else if (panresData.categories.Phenotype.includes(item.id)) typeLabel = 'Phenotype';
                        else if (panresData.categories.Mechanism.includes(item.id)) typeLabel = 'Mechanism';
                        else if (panresData.categories.Database.includes(item.id)) typeLabel = 'Database';

                        return `
                            <div class="py-2 px-3 hover:bg-accent-2 hover:bg-opacity-20 cursor-pointer border-b border-gray-200"
                                 onclick="showDetails('${item.id}')">
                                <div class="font-medium text-primary">${item.label}</div>
                                <div class="text-xs text-gray-500">${item.id} ‚Ä¢ ${typeLabel}</div>
                            </div>
                        `;
                    }).join('');

                document.getElementById('searchResults').innerHTML = resultsHtml
                    ? `<div class="border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">${resultsHtml}</div>`
                    : '<div class="text-sm text-gray-500 p-2">No results found</div>';
            }, 300);
        });

        // Initialize on load
        loadData();
    </script>
</body>
</html>
